
steps:
- checkout: self
  clean: true
  fetchDepth: 5
  submodules: true

- task: DownloadBuildArtifacts@0
  inputs:
    buildType: specific
    project: fenics
    pipeline: chrisrichardson.petsc
    buildVersionToDownload: latest
    downloadType: single
    artifactName: petsc_tarball
  displayName: Download PETSc install for MacOS

- bash: |
    echo $SYSTEM_ARTIFACTSDIRECTORY
    cd /
    sudo tar xf $SYSTEM_ARTIFACTSDIRECTORY/petsc-install-macos.tar.gz
  displayName: Extract PETSc install

- bash: |
    brew update
    brew install pkg-config eigen open-mpi boost python3 bison flex
    brew install hdf5 --with-mpi
    wget http://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-lite-3.10.2.tar.gz
    tar xf petsc-lite-3.10.2.tar.gz
    cd petsc-3.10.2 && \
    ./configure \
    --COPTFLAGS="-O2 -g" \
    --CXXOPTFLAGS="-O2 -g" \
    --FOPTFLAGS="-O2 -g" \
    --with-debugging=yes \
    --with-fortran-bindings=no \
    --download-blacs \
    --download-hypre \
    --download-metis \
    --download-mumps \
    --download-ptscotch \
    --download-scalapack \
    --download-spai \
    --download-suitesparse \
    --download-superlu \
    --with-scalar-type=real \
    --prefix=/usr/local && \
    make && \
    sudo make install
  displayName: Install PETSc

- bash: |
    pip3 -q install cffi decorator flake8 matplotlib numba pygmsh pytest pytest-xdist sphinx sphinx_rtd_theme --upgrade
    pip3 install git+https://bitbucket.org/fenics-project/fiat.git --upgrade
    pip3 install git+https://bitbucket.org/fenics-project/ufl.git --upgrade
    pip3 install git+https://bitbucket.org/fenics-project/dijitso.git --upgrade
    pip3 install git+https://github.com/FEniCS/ffcx --no-deps --upgrade
  displayName: Install Homebrew dependencies and Python3 dependencies

- task: CMake@1
  displayName: CMake
  inputs:
    workingDirectory: cpp/build
    cmakeArgs: '-DCMAKE_INSTALL_PREFIX=$HOME/FEniCS ..'

- script: make -j4
  displayName: Build
  workingDirectory: cpp/build
